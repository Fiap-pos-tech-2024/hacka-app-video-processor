name: Build and Push Docker Image to ECR and Redeploy ECS - Video Processor

on:
  push:
    branches: [ main ]
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::816069165502:role/gh-actions-video-upload-service-role
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to ECR (no cache)
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: hacka-app-processor
          IMAGE_TAG: latest
        run: |
          echo "Forçando build sem cache para Video Processor..."
          aws ecr describe-repositories --repository-names $ECR_REPOSITORY --region us-east-1 || \
          aws ecr create-repository --repository-name $ECR_REPOSITORY --region us-east-1

          docker image rm $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG || true
          docker build --no-cache -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Force new ECS deployment
        run: |
          aws ecs update-service \
            --cluster microservices-cluster \
            --service video-processor \
            --force-new-deployment \
            --region us-east-1

      - name: Wait for service stability
        run: |
          echo " Aguardando estabilidade do serviço..."
          aws ecs wait services-stable \
            --cluster microservices-cluster \
            --services video-processor \
            --region us-east-1
          echo "[SUCCESS] Serviço Video Processor estável!"

      - name: Verify ECS service status
        run: |
          echo "[INFO] Verificando status do serviço ECS..."
          SERVICE_STATUS=$(aws ecs describe-services \
            --cluster microservices-cluster \
            --services video-processor \
            --region us-east-1 \
            --query "services[0].status" \
            --output text)
          
          RUNNING_COUNT=$(aws ecs describe-services \
            --cluster microservices-cluster \
            --services video-processor \
            --region us-east-1 \
            --query "services[0].runningCount" \
            --output text)
            
          DESIRED_COUNT=$(aws ecs describe-services \
            --cluster microservices-cluster \
            --services video-processor \
            --region us-east-1 \
            --query "services[0].desiredCount" \
            --output text)
          
          echo "[STATUS] Status do serviço: $SERVICE_STATUS"
          echo "[TASKS] Tasks rodando: $RUNNING_COUNT/$DESIRED_COUNT"
          
          if [ "$RUNNING_COUNT" = "$DESIRED_COUNT" ] && [ "$SERVICE_STATUS" = "ACTIVE" ]; then
            echo "[SUCCESS] Processador de vídeo funcionando corretamente!"
          else
            echo "[WAIT] Aguardando todas as tasks ficarem prontas..."
          fi

      - name: Print service information
        run: |
          echo "Video Processor (Queue Worker) - Informações do Deploy:"
          echo "Cluster: microservices-cluster"
          echo "Serviço: video-processor"
          echo "Fila SQS: video-processing-queue"
          echo "Bucket S3: video-processor-storage-*"
          echo "Tipo: Processador de fila (sem API HTTP)"

  deploy-notification:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: always()

    steps:
      - name: Deploy status notification
        run: |
          if [ "${{ needs.build-and-deploy.result }}" == "success" ]; then
            echo "Deploy do Video Processor realizado com sucesso!"
            echo "O processador está rodando e monitorando a fila SQS."
            echo "Processando mensagens da fila: video-processing-queue"
            echo "O serviço está extraindo frames dos vídeos automaticamente."
          else
            echo "Falha no deploy do Video Processor."
            echo "Verifique os logs do GitHub Actions para mais detalhes."
          fi
